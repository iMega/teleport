machine:
  services:
    - docker
  pre:
    - sudo curl -L -o /usr/bin/docker 'http://s3-external-1.amazonaws.com/circle-downloads/docker-1.6.2-circleci'; sudo chmod 0755 /usr/bin/docker; true
  php:
    version: 5.6.5

dependencies:
  post:
    - rm -r ~/.gradle
  override:
    - docker build -f teleport.docker -t imega/teleport .
    - mkdir -p ./build/db
    - docker run -d --name "teleport_db" -v $PWD/build/db:/var/lib/mysql imega/mysql
    - docker run --rm -v $PWD/build/sql:/sql --link teleport_db:teleport_db imega/mysql-client:1.1.0 mysqladmin --silent --host=teleport_db --wait=5 ping
    - composer install --prefer-source --no-interaction

test:
  override:
    - vendor/bin/phpunit
